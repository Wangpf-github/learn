#include <stdio.h>
#include <time.h>
#include <sys/types.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <stdlib.h>
#include <string.h>

/*******************************************************************************
* LOCAL INCLUDE FILES
*******************************************************************************/
//#include "oled.h"
#include "font.h"

/******************************************************************************
* LOCAL MACROS AND DEFINITIONS
******************************************************************************/        
#define OLED_ADDRESS    0x78
#define I2C_RETRIES     0x0701  /* number of times a device address should
				   be polled when not acknowledging */
#define I2C_TIMEOUT     0x0702  /* set timeout in units of 10 ms */
/* NOTE: Slave address is 7 or 10 bits, but 10-bit addresses
 * are NOT supported! (due to code brokenness)
 */
#define I2C_SLAVE       0x0703  /* Use this slave address */
#define I2C_SLAVE_FORCE 0x0706  /* Use this slave address, even if it
				   is already in use by a driver! */
#define I2C_TENBIT      0x0704  /* 0 for 7 bit addrs, != 0 for 10 bit */

#define I2C_FUNCS       0x0705  /* Get the adapter functionality mask */

#define I2C_RDWR        0x0707  /* Combined R/W transfer (one STOP only) */

#define I2C_PEC         0x0708  /* != 0 to use PEC with SMBus */
#define I2C_SMBUS       0x0720
#define I2C_16BIT_REG   0x0709  /* 16BIT REG WIDTH */
#define I2C_16BIT_DATA  0x070a  /* 16BIT DATA WIDTH */
typedef unsigned char uint8_t;
typedef char u8;
typedef enum
{
   FONT_16 = 0,
   FONT_12 = 1,
}OLED_CHARSIZE;

typedef enum
{
   PARA = 0,
   DATA = 0x40,
}OLED_PARE_REG;

typedef enum
{
   X_WIDTH = 128,
   Y_WIDTH = 64,
}OLED_SCREEN_SIZE;

const unsigned char bird[]={
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xC0,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0x00,0x70,0x1F,0xFF,
0xFF,0xFF,0xFF,0xC0,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0x00,0x70,0x1F,0xFF,
0xFF,0xFF,0xFF,0x80,0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0x00,0x10,0x07,0xFF,
0xFF,0xFF,0xF8,0x00,0x30,0x00,0x7F,0xFF,0xFF,0xFF,0xFF,0xFE,0x00,0x00,0x03,0xFF,
0xFF,0xFF,0xF8,0x00,0x30,0x00,0x7F,0xFF,0xFF,0xFF,0xFF,0xFE,0x00,0x00,0x03,0xFF,
0xFF,0xE0,0x08,0x00,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0xFF,0xFE,0x00,0x00,0x03,0xFF,
0xFF,0xE0,0x08,0x00,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0xFF,0xFE,0x00,0x00,0x03,0xFF,
0xFF,0xC0,0x08,0x00,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0xFF,0xFE,0x00,0x00,0x00,0x1F,
0xFF,0xC0,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x07,
0xFF,0xC0,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x07,
0xFF,0xC0,0x00,0x00,0x00,0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x07,
0xFF,0xC0,0x00,0x00,0x00,0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x07,
0xFF,0xC0,0x00,0x00,0x00,0x0F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x07,
0xFF,0xC0,0x00,0x00,0x00,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x07,
0xFF,0xC0,0x00,0x00,0x00,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x07,
0xF8,0x00,0x00,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x1F,
0xF8,0x00,0x00,0x00,0x01,0xFF,0xFF,0x00,0x3F,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x07,
0xF8,0x00,0x00,0x00,0x01,0xFF,0xFF,0x00,0x3F,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x07,
0xF8,0x00,0x00,0x00,0x03,0xFF,0xFF,0x00,0x01,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x07,
0xF8,0x00,0x00,0x00,0x03,0xFF,0xFF,0x00,0x01,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x07,
0xF8,0x00,0x00,0x00,0x03,0xFC,0x00,0x00,0x00,0xFF,0xFF,0xFE,0x00,0x00,0x00,0x07,
0xFE,0x00,0x00,0x00,0x03,0xFC,0x00,0x00,0x00,0x3F,0xFF,0xFE,0x00,0x00,0x00,0x07,
0xFE,0x00,0x00,0x00,0x03,0xFC,0x00,0x00,0x00,0x3F,0xFF,0xFE,0x00,0x00,0x00,0x07,
0xF8,0x00,0x00,0x00,0x0F,0xFC,0x00,0x00,0x00,0x07,0xFF,0xFC,0x00,0x00,0x00,0x1F,
0xF8,0x00,0x00,0x00,0x0F,0xFC,0x00,0x00,0x00,0x07,0xFF,0xFC,0x00,0x00,0x00,0x1F,
0xF8,0x00,0x00,0x00,0x03,0xFF,0x00,0x00,0x00,0x00,0x3F,0xC0,0x00,0x00,0x00,0x7F,
0xF8,0x00,0x00,0x00,0x03,0xFC,0x00,0x00,0x00,0x00,0x0F,0x80,0x00,0x00,0x00,0x7F,
0xF8,0x00,0x00,0x00,0x03,0xFC,0x00,0x00,0x00,0x00,0x0F,0x80,0x00,0x00,0x00,0x7F,
0xFE,0x00,0x00,0x00,0x01,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0xFF,
0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0xFF,
0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0xFF,
0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0xFF,
0xFF,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0xFF,
0xFF,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xFF,0xFF,
0xFF,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xFF,0xFF,
0xFF,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x0F,0xFF,0xFF,
0xFF,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x0F,0xFF,0xFF,
0xFF,0xFF,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0xC0,0x08,0x00,0x03,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x7F,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x7F,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x01,0xFE,0x00,0x03,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x07,0xFF,0x00,0x03,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x07,0xFF,0x00,0x03,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFC,0x00,0x00,0x7F,0xE1,0xFE,0x00,0x0F,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFE,0x00,0x03,0xFF,0xF8,0x20,0x00,0x0F,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFE,0x00,0x03,0xFF,0xF8,0x20,0x00,0x0F,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0x80,0x7F,0xFF,0xFF,0x01,0xC0,0x7F,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0x80,0x7F,0xFF,0xFF,0x01,0xC0,0x7F,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xE0,0x7F,0xFF,0xFF,0xFF,0xC1,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFC,0x03,0xFF,0xFF,0xE0,0x07,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFC,0x03,0xFF,0xFF,0xE0,0x07,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xE0,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
}




static uint8_t charSize;
int i2c_fd;
/******************************************************************************
* LOCAL FUNCTION DECLARATIONS
******************************************************************************/
static void oled_WriteRegister(uint8_t val,  uint8_t reg);
static int i2c_WriteRegister(uint8_t val ,uint8_t reg);
void delay(unsigned int i);
void oled_Clear(void);
/******************************************************************************
* EXPORTED FUNCTIONS
******************************************************************************/
void oled_Init(void)
{         
    i2c_WriteRegister(0xAE,PARA);//--display off
    i2c_WriteRegister(0x00,PARA);//---set low column address
    i2c_WriteRegister(0x10,PARA);//---set high column address
    i2c_WriteRegister(0x40,PARA);//--set start line address  
    i2c_WriteRegister(0xB0,PARA);//--set page address
    i2c_WriteRegister(0x81,PARA); // contract control

	i2c_WriteRegister(0xFF,PARA);//--128       //i2c_WriteRegister(0x8f,PARA);
    i2c_WriteRegister(0xA0,PARA);//set segment remap 
//  i2c_WriteRegister(0xA4,PARA);
    i2c_WriteRegister(0xA6,PARA);//--normal / reverse
    i2c_WriteRegister(0xA8,PARA);//--set multiplex ratio(1 to 64)
    i2c_WriteRegister(0x3F,PARA);//--1/32 duty
    i2c_WriteRegister(0xC0,PARA);//Com scan direction
    i2c_WriteRegister(0xD3,PARA);//-set display offset
    i2c_WriteRegister(0x00,PARA);//

    i2c_WriteRegister(0xD5,PARA);//set osc division
    i2c_WriteRegister(0x80,PARA);//

    i2c_WriteRegister(0xD8,PARA);//set area color mode off
    i2c_WriteRegister(0x05,PARA);//

    i2c_WriteRegister(0xD9,PARA);//Set Pre-Charge Period
    i2c_WriteRegister(0xF1,PARA);//

//	i2c_WriteRegister(0xD9,PARA));    /*set pre-charge period*/
//  i2c_WriteRegister(0x22,PARA);//

    i2c_WriteRegister(0xDA,PARA);//set com pin configuartion
    i2c_WriteRegister(0x12,PARA);//

    i2c_WriteRegister(0xDB,PARA);//set Vcomh
    i2c_WriteRegister(0x30,PARA);//

    i2c_WriteRegister(0x8D,PARA);//set charge pump enable
    i2c_WriteRegister(0x14,PARA);//

    i2c_WriteRegister(0xAF,PARA);//--turn on oled panel
    
    oled_Clear();
 
} 

void oled_SetCharSize( uint8_t val )
{
   charSize = val;
}

void delay(unsigned int i)							
{
   	while(i>0)
   	{
		i--;
   	}
}

void oled_SetPostion( uint8_t x, uint8_t y) 
{         
    i2c_WriteRegister(0xb0+y,PARA);
    i2c_WriteRegister(((x&0xf0)>>4)|0x10,PARA);
    i2c_WriteRegister((x&0x0f),PARA); 
}             

void oled_displayOn(void)
{
    i2c_WriteRegister(0X8D,PARA); 
    i2c_WriteRegister(0X14,PARA); 
    i2c_WriteRegister(0XAF,PARA);
}
  
void oled_DisplayOff(void)
{
    i2c_WriteRegister(0X8D,PARA);
    i2c_WriteRegister(0X10,PARA);
    i2c_WriteRegister(0XAE,PARA);
}                                            

void oled_Clear(void)  
{  
  uint8_t i,n;
  
  for(i=0;i<8;i++)  
  {  
      i2c_WriteRegister (0xb0+i,PARA);   
      i2c_WriteRegister (0x00,PARA);
      i2c_WriteRegister (0x10,PARA); 
      
      for( n = 0;n < 128; n++)
      {
          i2c_WriteRegister(0,DATA);
      } 
  } 
}

void oled_UpScreenOn(void)  
{  
    uint8_t i,n;
    
    for(i=0;i<8;i++)  
    {  
        i2c_WriteRegister (0xb0+i,PARA);
        i2c_WriteRegister (0x00,PARA); 
        i2c_WriteRegister (0x10,PARA);
        
        for(n=0;n<128;n++)
        {
            i2c_WriteRegister(1,DATA); 
        }
    } 
}

void oled_PrintfChar(uint8_t x,uint8_t y,uint8_t val )
{              
    uint8_t character = 0;
    uint8_t i=0;        
    
    character = val-' ';                
    if( x > X_WIDTH-1)
    {
      x = 0;
      y += 2;
    }
    
    if( charSize == FONT_16 )
    {
          oled_SetPostion(x,y);        
          for( i = 0; i < 8; i++)
          {
              i2c_WriteRegister(F8X16[character*16+i],DATA);
          }
          
          oled_SetPostion(x,y+1);
          for(i=0;i<8;i++)
          {
              i2c_WriteRegister(F8X16[character*16+i+8],DATA);
          }
     }
    else 
    {        
        oled_SetPostion(x,y);
        for(i=0;i<6;i++)
        {
            i2c_WriteRegister(F6x8[character*6+i],DATA);
        }
    }
}

void oled_PrintfString(uint8_t x,uint8_t y,u8 *str  )
{
    uint8_t index = 0;
    
    while ( str[index]!='\0' )
    {                
        oled_PrintfChar(x,y,str[index] );
       
        x += 8;
        if( x > 120 )
        {  
            x=0;
            y+=2;
        }
        index++;
    }
}

/******************************************************************************
* LOCAL FUNCTIONS
******************************************************************************/
/*
static void oled_WriteRegister(uint8_t val,  uint8_t reg)
{  
    i2c_Start();
    
    i2c_SendByte( OLED_ADDRESS );   //Slave address,SA0=0   
    i2c_WaitAck();        
    
    i2c_SendByte( reg );            //write register 
    i2c_WaitAck();        
    
    i2c_SendByte( val );    
    i2c_WaitAck();
    
    i2c_Stop();    
}
*/  //基于单片机
char *strRev(char *s)
{
	char *p = s;
    char temp, *end = s + strlen(s) - 1;
    while( end > s)
    {
        temp = *s;
        *s = *end;
        *end = temp;
        --end;
        ++s;
    }
    return p;
}
int main()      //测试代码
{
	int i = 1;	
	time_t t;
	struct tm *lt;
	char buf1[20]={0};
	char buf2[20]={0};
	char teche[20]={0};
	char *rev;
	i2c_fd = open("/dev/i2c-10",O_RDWR);
	if(i2c_fd < 0)
	{
		printf("open dev error\n");
		return -1;
	}
	oled_Init();
//	oled_UpScreenOn();
	while(1)
	{
//		oled_Clear();	
		sprintf(buf1, "TECHE TEST1-%d", i);
		sprintf(buf2, "TECHE TEST2-%d", i);
		i++;
		if(i>9)
			i=0;
	//	oled_SetCharSize( FONT_16 );  
//		usleep(10000);
	//	oled_PrintfString(5, 0, "TECHE TEST1- ");  
	//	oled_PrintfString(5, 0, buf1);  
	//	oled_PrintfString(5, 2, "TECHE TEST2- ");  
	//	oled_PrintfString(5, 2, buf2);  
	//	oled_SetCharSize( FONT_12 );
	//	oled_PrintfString(35, 6, "Teche");  
//		rev = strRev(teche);
//		oled_PrintfString(30, 6, rev);
//		oled_PrintfString(63, 6,"CODE:");
	}
}

static int i2c_WriteRegister(uint8_t val ,uint8_t reg)
{
	unsigned int index = 0;
	char buf[2] = {0};
//	i2c_Start();
	int ret = ioctl(i2c_fd, I2C_SLAVE_FORCE, OLED_ADDRESS); //I2C_SLAVE_FORCE如何设置？？
	if (ret < 0) {
		printf("CMD_SET_DEV error!\n");
		close(i2c_fd);
		return -1;
	}
	ret = ioctl(i2c_fd, I2C_16BIT_REG, 0);  //I2C_16BIT_REG如何设置？？
	if (ret < 0) {
		printf("CMD_SET_REG_WIDTH error!\n");
		close(i2c_fd);
		return -1;
	}
	ret = ioctl(i2c_fd, I2C_16BIT_DATA, 0);   //I2C_16BIT_DATA如何设置？？
	if (ret < 0) {
		printf("CMD_SET_DATA_WIDTH error!\n");
		close(i2c_fd);
		return -1;
	}
	buf[index] = reg & 0xff;
	index++;
	buf[index] = val & 0xff;
	write(i2c_fd, buf, 2);   //写入数据
	if(ret < 0)
	{
		printf("I2C_WRITE error!\n");
		close(i2c_fd);
		return -1;
	}
//	i2c_Stop();
}
